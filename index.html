<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Tax Model Comparison</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 0;
        }
        
        .sidebar {
            background: #f8f9fa;
            padding: 30px;
            border-right: 1px solid #dee2e6;
        }
        
        .content {
            padding: 40px;
        }
        
        .param-section {
            margin-bottom: 30px;
        }
        
        .param-section h3 {
            color: #667eea;
            font-size: 1.1em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .param-group {
            margin-bottom: 20px;
        }
        
        .param-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
            font-size: 0.9em;
        }
        
        .param-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        .param-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .param-group .value-display {
            display: inline-block;
            float: right;
            color: #667eea;
            font-weight: 700;
        }
        
        .calculate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 20px;
        }
        
        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .calculate-btn:active {
            transform: translateY(0);
        }
        
        .metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .metric-card h3 {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .metric-card .value {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .metric-card.forfait .value { color: #FF6B6B; }
        .metric-card.accrual .value { color: #4ECDC4; }
        .metric-card.labor .value { color: #95E1D3; }
        
        .metric-card .tax {
            font-size: 0.9em;
            color: #6c757d;
        }
        
        .chart-section {
            margin-bottom: 40px;
        }
        
        .chart-section h2 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 40px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 15px;
            overflow: hidden;
        }
        
        .comparison-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .comparison-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        .comparison-table td {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .comparison-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .download-btn {
            padding: 12px 24px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .download-btn:hover {
            background: #218838;
        }
        
        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .metrics {
                grid-template-columns: 1fr;
            }
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-weight: 600;
        }
        
        .loading.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¶ Investment Tax Model Comparison</h1>
            <p>Compare three taxation models on investment returns using S&P 500 (SPY) data from 2001-2024</p>
        </div>
        
        <div class="main-content">
            <div class="sidebar">
                <div class="param-section">
                    <h3>Investment Settings</h3>
                    <div class="param-group">
                        <label for="initial">Initial Investment (EUR)</label>
                        <input type="number" id="initial" value="100000" step="1000" min="0">
                    </div>
                    <div class="param-group">
                        <label for="monthly">Monthly Contribution (EUR)</label>
                        <input type="number" id="monthly" value="1000" step="100" min="0">
                    </div>
                </div>
                
                <div class="param-section">
                    <h3>Box 3 Old School</h3>
                    <div class="param-group">
                        <label for="forfaitR">Deemed Return Rate (%): <span class="value-display" id="forfaitR-val">4.0</span></label>
                        <input type="range" id="forfaitR" min="0" max="10" step="0.1" value="4.0">
                    </div>
                    <div class="param-group">
                        <label for="forfaitTax">Tax Rate (%): <span class="value-display" id="forfaitTax-val">30</span></label>
                        <input type="range" id="forfaitTax" min="0" max="100" step="1" value="30">
                    </div>
                </div>
                
                <div class="param-section">
                    <h3>Box 3 Revamped</h3>
                    <div class="param-group">
                        <label for="accrualTax">Tax Rate (%): <span class="value-display" id="accrualTax-val">36</span></label>
                        <input type="range" id="accrualTax" min="0" max="100" step="1" value="36">
                    </div>
                </div>
                
                <div class="param-section">
                    <h3>Timmerfrans Special</h3>
                    <div class="param-group">
                        <label for="laborTax">Tax Rate (%): <span class="value-display" id="laborTax-val">55</span></label>
                        <input type="range" id="laborTax" min="0" max="100" step="1" value="55">
                    </div>
                    <div class="param-group">
                        <label for="wealthTax">Wealth Tax Rate (%): <span class="value-display" id="wealthTax-val">1.0</span></label>
                        <input type="range" id="wealthTax" min="0" max="5" step="0.1" value="1.0">
                    </div>
                    <div class="param-group">
                        <label for="wealthThreshold">Wealth Tax Threshold (EUR)</label>
                        <input type="number" id="wealthThreshold" value="200000" step="10000" min="0">
                    </div>
                </div>
                
                <button class="calculate-btn" onclick="calculate()">üîÑ Calculate</button>
            </div>
            
            <div class="content">
                <div class="loading" id="loading">Calculating...</div>
                
                <div id="results" style="display:none;">
                    <h2 style="margin-bottom: 20px;">üìà Final Results Summary</h2>
                    
                    <div class="metrics">
                        <div class="metric-card forfait">
                            <h3>Box 3 Old School</h3>
                            <div class="value" id="forfait-value">‚Ç¨0</div>
                            <div class="tax" id="forfait-tax">Tax: ‚Ç¨0</div>
                        </div>
                        <div class="metric-card accrual">
                            <h3>Box 3 Revamped</h3>
                            <div class="value" id="accrual-value">‚Ç¨0</div>
                            <div class="tax" id="accrual-tax">Tax: ‚Ç¨0</div>
                        </div>
                        <div class="metric-card labor">
                            <h3>Timmerfrans Special</h3>
                            <div class="value" id="labor-value">‚Ç¨0</div>
                            <div class="tax" id="labor-tax">Tax: ‚Ç¨0</div>
                        </div>
                    </div>
                    
                    <div class="info-box" id="contribution-info">
                        üí∞ Total Contributed: ‚Ç¨0 over 0 months
                    </div>
                    
                    <div class="chart-section">
                        <h2>üìâ Portfolio Value Over Time</h2>
                        <div class="chart-container">
                            <canvas id="portfolioChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-section">
                        <h2>üí∏ Cumulative Tax Paid</h2>
                        <div class="chart-container">
                            <canvas id="taxChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-section">
                        <h2>üìä Detailed Comparison</h2>
                        <table class="comparison-table">
                            <thead>
                                <tr>
                                    <th>Model</th>
                                    <th>Final Portfolio Value</th>
                                    <th>Total Tax Paid</th>
                                    <th>Net Gain</th>
                                    <th>Effective Tax Rate</th>
                                </tr>
                            </thead>
                            <tbody id="comparison-tbody">
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="chart-section">
                        <h2>üíæ Download Results</h2>
                        <button class="download-btn" onclick="downloadCSV()">üì• Download Results as CSV</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // SPY Data (2001-2024)
        const SPY_DATA = {
            '2001-01-31': 128.82, '2001-02-28': 119.77, '2001-03-30': 113.49, '2001-04-30': 121.61,
            '2001-05-31': 121.88, '2001-06-29': 119.53, '2001-07-31': 117.93, '2001-08-31': 112.52,
            '2001-09-28': 103.30, '2001-10-31': 107.48, '2001-11-30': 114.28, '2001-12-31': 115.36,
            '2002-01-31': 112.58, '2002-02-28': 110.67, '2002-03-28': 114.50, '2002-04-30': 109.14,
            '2002-05-31': 107.85, '2002-06-28': 100.02, '2002-07-31': 94.18, '2002-08-30': 95.48,
            '2002-09-30': 86.62, '2002-10-31': 92.64, '2002-11-29': 96.73, '2002-12-31': 92.93,
            '2003-01-31': 90.53, '2003-02-28': 88.77, '2003-03-31': 89.83, '2003-04-30': 95.40,
            '2003-05-30': 99.88, '2003-06-30': 100.19, '2003-07-31': 102.58, '2003-08-29': 104.05,
            '2003-09-30': 103.57, '2003-10-31': 108.24, '2003-11-28': 108.98, '2003-12-31': 111.23,
            '2004-01-30': 113.71, '2004-02-27': 115.73, '2004-03-31': 114.55, '2004-04-30': 114.34,
            '2004-05-28': 115.37, '2004-06-30': 116.84, '2004-07-30': 112.38, '2004-08-31': 113.15,
            '2004-09-30': 113.27, '2004-10-29': 115.30, '2004-11-30': 119.67, '2004-12-31': 121.58,
            '2005-01-31': 119.38, '2005-02-28': 121.54, '2005-03-31': 119.17, '2005-04-29': 117.93,
            '2005-05-31': 120.73, '2005-06-30': 120.19, '2005-07-29': 123.56, '2005-08-31': 122.26,
            '2005-09-30': 123.63, '2005-10-31': 121.82, '2005-11-30': 125.40, '2005-12-30': 125.36,
            '2006-01-31': 128.87, '2006-02-28': 128.73, '2006-03-31': 130.00, '2006-04-28': 131.24,
            '2006-05-31': 128.04, '2006-06-30': 128.15, '2006-07-31': 128.28, '2006-08-31': 131.47,
            '2006-09-29': 133.96, '2006-10-31': 137.81, '2006-11-30': 139.70, '2006-12-29': 141.60,
            '2007-01-31': 141.97, '2007-02-28': 142.19, '2007-03-30': 143.76, '2007-04-30': 148.36,
            '2007-05-31': 151.88, '2007-06-29': 149.96, '2007-07-31': 146.14, '2007-08-31': 146.50,
            '2007-09-28': 151.68, '2007-10-31': 153.48, '2007-11-30': 147.05, '2007-12-31': 146.21,
            '2008-01-31': 135.07, '2008-02-29': 136.00, '2008-03-31': 132.65, '2008-04-30': 139.49,
            '2008-05-30': 140.28, '2008-06-30': 131.19, '2008-07-31': 126.39, '2008-08-29': 129.37,
            '2008-09-30': 116.77, '2008-10-31': 101.48, '2008-11-28': 90.24, '2008-12-31': 90.24,
            '2009-01-30': 82.83, '2009-02-27': 73.93, '2009-03-31': 79.73, '2009-04-30': 87.24,
            '2009-05-29': 92.53, '2009-06-30': 91.99, '2009-07-31': 98.06, '2009-08-31': 101.51,
            '2009-09-30': 106.72, '2009-10-30': 103.56, '2009-11-30': 110.99, '2009-12-31': 111.44,
            '2010-01-29': 107.39, '2010-02-26': 110.74, '2010-03-31': 117.64, '2010-04-30': 118.81,
            '2010-05-28': 109.43, '2010-06-30': 103.27, '2010-07-30': 112.77, '2010-08-31': 107.64,
            '2010-09-30': 114.59, '2010-10-29': 118.81, '2010-11-30': 119.41, '2010-12-31': 125.75,
            '2011-01-31': 128.27, '2011-02-28': 132.18, '2011-03-31': 132.47, '2011-04-29': 135.14,
            '2011-05-31': 133.42, '2011-06-30': 130.84, '2011-07-29': 127.49, '2011-08-31': 120.92,
            '2011-09-30': 112.77, '2011-10-31': 124.60, '2011-11-30': 125.75, '2011-12-30': 126.24,
            '2012-01-31': 131.89, '2012-02-29': 136.05, '2012-03-30': 139.84, '2012-04-30': 137.91,
            '2012-05-31': 133.13, '2012-06-29': 136.30, '2012-07-31': 138.54, '2012-08-31': 140.99,
            '2012-09-28': 143.97, '2012-10-31': 142.11, '2012-11-30': 142.71, '2012-12-31': 142.41,
            '2013-01-31': 150.20, '2013-02-28': 151.08, '2013-03-28': 156.73, '2013-04-30': 158.98,
            '2013-05-31': 164.85, '2013-06-28': 162.73, '2013-07-31': 169.30, '2013-08-30': 164.11,
            '2013-09-30': 168.10, '2013-10-31': 175.77, '2013-11-29': 179.97, '2013-12-31': 184.69,
            '2014-01-31': 177.72, '2014-02-28': 185.47, '2014-03-31': 186.98, '2014-04-30': 188.23,
            '2014-05-30': 192.46, '2014-06-30': 195.61, '2014-07-31': 194.72, '2014-08-29': 200.07,
            '2014-09-30': 198.84, '2014-10-31': 205.00, '2014-11-28': 208.92, '2014-12-31': 205.54,
            '2015-01-30': 199.44, '2015-02-27': 211.00, '2015-03-31': 207.40, '2015-04-29': 209.84,
            '2015-05-29': 211.90, '2015-06-30': 207.84, '2015-07-31': 209.58, '2015-08-31': 198.84,
            '2015-09-30': 192.66, '2015-10-30': 210.20, '2015-11-30': 210.59, '2015-12-31': 203.87,
            '2016-01-29': 194.02, '2016-02-29': 193.00, '2016-03-31': 206.33, '2016-04-29': 207.40,
            '2016-05-31': 211.04, '2016-06-30': 211.70, '2016-07-29': 217.12, '2016-08-31': 217.38,
            '2016-09-30': 216.30, '2016-10-31': 214.99, '2016-11-30': 220.38, '2016-12-30': 223.53,
            '2017-01-31': 227.76, '2017-02-28': 236.47, '2017-03-31': 236.37, '2017-04-28': 238.97,
            '2017-05-31': 241.80, '2017-06-30': 243.43, '2017-07-31': 248.41, '2017-08-31': 247.52,
            '2017-09-29': 250.33, '2017-10-31': 255.67, '2017-11-30': 263.13, '2017-12-29': 266.86,
            '2018-01-31': 281.18, '2018-02-28': 272.98, '2018-03-29': 265.10, '2018-04-30': 266.60,
            '2018-05-31': 272.38, '2018-06-29': 272.13, '2018-07-31': 281.84, '2018-08-31': 289.81,
            '2018-09-28': 290.89, '2018-10-31': 268.09, '2018-11-30': 278.81, '2018-12-31': 249.92,
            '2019-01-31': 270.47, '2019-02-28': 279.35, '2019-03-29': 283.40, '2019-04-30': 293.87,
            '2019-05-31': 276.74, '2019-06-28': 295.87, '2019-07-31': 300.09, '2019-08-30': 293.47,
            '2019-09-30': 296.77, '2019-10-31': 304.70, '2019-11-29': 314.08, '2019-12-31': 321.86,
            '2020-01-31': 321.34, '2020-02-28': 298.77, '2020-03-31': 254.87, '2020-04-30': 289.63,
            '2020-05-29': 304.02, '2020-06-30': 306.65, '2020-07-31': 322.17, '2020-08-31': 351.88,
            '2020-09-30': 335.48, '2020-10-30': 326.54, '2020-11-30': 362.75, '2020-12-31': 370.07,
            '2021-01-29': 370.83, '2021-02-26': 380.36, '2021-03-31': 395.62, '2021-04-30': 416.98,
            '2021-05-28': 418.83, '2021-06-30': 429.11, '2021-07-30': 439.29, '2021-08-31': 449.37,
            '2021-09-30': 429.26, '2021-10-29': 458.77, '2021-11-30': 453.05, '2021-12-31': 474.96,
            '2022-01-31': 441.61, '2022-02-28': 435.28, '2022-03-31': 454.34, '2022-04-29': 413.25,
            '2022-05-31': 414.53, '2022-06-30': 379.44, '2022-07-29': 408.49, '2022-08-31': 395.25,
            '2022-09-30': 357.04, '2022-10-31': 386.22, '2022-11-30': 398.11, '2022-12-30': 382.46,
            '2023-01-31': 401.03, '2023-02-28': 394.33, '2023-03-31': 407.77, '2023-04-28': 410.91,
            '2023-05-31': 420.55, '2023-06-30': 441.41, '2023-07-31': 448.68, '2023-08-31': 448.48,
            '2023-09-29': 429.38, '2023-10-31': 420.99, '2023-11-30': 450.52, '2023-12-29': 471.63,
            '2024-01-31': 484.98, '2024-02-29': 509.80, '2024-03-28': 523.95, '2024-04-30': 503.48,
            '2024-05-31': 526.33, '2024-06-28': 544.47, '2024-07-31': 549.96, '2024-08-30': 563.07,
            '2024-09-30': 573.37, '2024-10-31': 573.39
        };
        
        let portfolioChart, taxChart;
        let calculationResults = null;
        
        // Update slider displays
        document.querySelectorAll('input[type="range"]').forEach(slider => {
            slider.addEventListener('input', function() {
                document.getElementById(this.id + '-val').textContent = this.value;
            });
        });
        
        function formatCurrency(value) {
            return '‚Ç¨' + Math.round(value).toLocaleString('en-US');
        }
        
        function simulateForfait(data, initial, monthly, rRate, taxRate) {
            let portfolioValue = initial;
            let shares = initial / data[0].price;
            let cumulativeTax = 0;
            let results = [];
            let firstOfYear = {};
            
            // Mark first data point of each year
            data.forEach((row, idx) => {
                const year = new Date(row.date).getFullYear();
                if (!firstOfYear[year]) {
                    firstOfYear[year] = idx;
                }
            });
            
            data.forEach((row, idx) => {
                // Apply monthly return
                if (idx > 0) {
                    shares = shares * (1 + row.monthlyReturn);
                }
                
                portfolioValue = shares * row.price;
                
                // Annual tax on first data point of year
                const year = new Date(row.date).getFullYear();
                if (firstOfYear[year] === idx && year > 2001) {
                    const taxBase = portfolioValue;
                    const taxAmount = taxBase * (rRate / 100) * (taxRate / 100);
                    cumulativeTax += taxAmount;
                    const sharesToSell = taxAmount / row.price;
                    shares -= sharesToSell;
                    portfolioValue = shares * row.price;
                }
                
                // Monthly contribution
                if (idx > 0) {
                    const newShares = monthly / row.price;
                    shares += newShares;
                    portfolioValue = shares * row.price;
                }
                
                results.push({
                    date: row.date,
                    portfolioValue: portfolioValue,
                    cumulativeTax: cumulativeTax
                });
            });
            
            return results;
        }
        
        function simulateAccrual(data, initial, monthly, taxRate) {
            let portfolioValue = initial;
            let shares = initial / data[0].price;
            let cumulativeTax = 0;
            let lossCarryforward = 0;
            let yearStartValue = initial;
            let results = [];
            
            data.forEach((row, idx) => {
                if (idx > 0) {
                    shares = shares * (1 + row.monthlyReturn);
                }
                
                portfolioValue = shares * row.price;
                
                // Annual tax on year end
                if (row.isYearEnd) {
                    const gain = portfolioValue - yearStartValue;
                    
                    if (gain > 0) {
                        const taxableGain = Math.max(0, gain - lossCarryforward);
                        lossCarryforward = Math.max(0, lossCarryforward - gain);
                        
                        if (taxableGain > 0) {
                            const taxAmount = taxableGain * (taxRate / 100);
                            cumulativeTax += taxAmount;
                            const sharesToSell = taxAmount / row.price;
                            shares -= sharesToSell;
                            portfolioValue = shares * row.price;
                        }
                    } else {
                        lossCarryforward += Math.abs(gain);
                    }
                    
                    yearStartValue = portfolioValue;
                }
                
                // Monthly contribution
                if (idx > 0) {
                    const newShares = monthly / row.price;
                    shares += newShares;
                    portfolioValue = shares * row.price;
                    
                    if (row.isYearEnd) {
                        yearStartValue = portfolioValue;
                    }
                }
                
                results.push({
                    date: row.date,
                    portfolioValue: portfolioValue,
                    cumulativeTax: cumulativeTax
                });
            });
            
            return results;
        }
        
        function simulateLabor(data, initial, monthly, taxRate, wealthTaxRate, wealthThreshold) {
            let portfolioValue = initial;
            let shares = initial / data[0].price;
            let cumulativeTax = 0;
            let cumulativeIncomeTax = 0;
            let cumulativeWealthTax = 0;
            let lossCarryforward = 0;
            let yearStartValue = initial;
            let results = [];
            
            data.forEach((row, idx) => {
                if (idx > 0) {
                    shares = shares * (1 + row.monthlyReturn);
                }
                
                portfolioValue = shares * row.price;
                
                // Annual taxes on year end
                if (row.isYearEnd) {
                    const gain = portfolioValue - yearStartValue;
                    
                    if (gain > 0) {
                        const taxableGain = Math.max(0, gain - lossCarryforward);
                        lossCarryforward = Math.max(0, lossCarryforward - gain);
                        
                        if (taxableGain > 0) {
                            const incomeTax = taxableGain * (taxRate / 100);
                            cumulativeTax += incomeTax;
                            cumulativeIncomeTax += incomeTax;
                            const sharesToSell = incomeTax / row.price;
                            shares -= sharesToSell;
                            portfolioValue = shares * row.price;
                        }
                    } else {
                        lossCarryforward += Math.abs(gain);
                    }
                    
                    // Wealth tax
                    if (portfolioValue > wealthThreshold) {
                        const wealthTax = (portfolioValue - wealthThreshold) * (wealthTaxRate / 100);
                        cumulativeTax += wealthTax;
                        cumulativeWealthTax += wealthTax;
                        const sharesToSell = wealthTax / row.price;
                        shares -= sharesToSell;
                        portfolioValue = shares * row.price;
                    }
                    
                    yearStartValue = portfolioValue;
                }
                
                // Monthly contribution
                if (idx > 0) {
                    const newShares = monthly / row.price;
                    shares += newShares;
                    portfolioValue = shares * row.price;
                    
                    if (row.isYearEnd) {
                        yearStartValue = portfolioValue;
                    }
                }
                
                results.push({
                    date: row.date,
                    portfolioValue: portfolioValue,
                    cumulativeTax: cumulativeTax,
                    cumulativeIncomeTax: cumulativeIncomeTax,
                    cumulativeWealthTax: cumulativeWealthTax
                });
            });
            
            return results;
        }
        
        function calculate() {
            // Show loading
            document.getElementById('loading').classList.add('active');
            document.getElementById('results').style.display = 'none';
            
            // Get parameters
            const initial = parseFloat(document.getElementById('initial').value);
            const monthly = parseFloat(document.getElementById('monthly').value);
            const forfaitR = parseFloat(document.getElementById('forfaitR').value);
            const forfaitTax = parseFloat(document.getElementById('forfaitTax').value);
            const accrualTax = parseFloat(document.getElementById('accrualTax').value);
            const laborTax = parseFloat(document.getElementById('laborTax').value);
            const wealthTax = parseFloat(document.getElementById('wealthTax').value);
            const wealthThreshold = parseFloat(document.getElementById('wealthThreshold').value);
            
            // Prepare data
            const dates = Object.keys(SPY_DATA).sort();
            const data = dates.map((date, idx) => {
                const price = SPY_DATA[date];
                const prevPrice = idx > 0 ? SPY_DATA[dates[idx - 1]] : price;
                const monthlyReturn = (price - prevPrice) / prevPrice;
                const dateObj = new Date(date);
                
                return {
                    date: date,
                    price: price,
                    monthlyReturn: monthlyReturn,
                    isYearEnd: dateObj.getMonth() === 11
                };
            });
            
            // Run simulations
            setTimeout(() => {
                const forfaitResults = simulateForfait(data, initial, monthly, forfaitR, forfaitTax);
                const accrualResults = simulateAccrual(data, initial, monthly, accrualTax);
                const laborResults = simulateLabor(data, initial, monthly, laborTax, wealthTax, wealthThreshold);
                
                calculationResults = {
                    forfait: forfaitResults,
                    accrual: accrualResults,
                    labor: laborResults,
                    dates: dates,
                    initial: initial,
                    monthly: monthly
                };
                
                displayResults();
                
                // Hide loading
                document.getElementById('loading').classList.remove('active');
                document.getElementById('results').style.display = 'block';
            }, 100);
        }
        
        function displayResults() {
            const { forfait, accrual, labor, dates, initial, monthly } = calculationResults;
            
            const forfaitFinal = forfait[forfait.length - 1];
            const accrualFinal = accrual[accrual.length - 1];
            const laborFinal = labor[labor.length - 1];
            
            const numMonths = dates.length - 1;
            const totalContributed = initial + (monthly * numMonths);
            
            // Update metrics
            document.getElementById('forfait-value').textContent = formatCurrency(forfaitFinal.portfolioValue);
            document.getElementById('forfait-tax').textContent = 'Tax: ' + formatCurrency(forfaitFinal.cumulativeTax);
            
            document.getElementById('accrual-value').textContent = formatCurrency(accrualFinal.portfolioValue);
            document.getElementById('accrual-tax').textContent = 'Tax: ' + formatCurrency(accrualFinal.cumulativeTax);
            
            document.getElementById('labor-value').textContent = formatCurrency(laborFinal.portfolioValue);
            document.getElementById('labor-tax').textContent = 'Tax: ' + formatCurrency(laborFinal.cumulativeTax);
            
            document.getElementById('contribution-info').textContent = 
                `üí∞ Total Contributed: ${formatCurrency(totalContributed)} over ${numMonths} months`;
            
            // Update comparison table
            const tbody = document.getElementById('comparison-tbody');
            tbody.innerHTML = `
                <tr>
                    <td><strong>Box 3 Old School</strong></td>
                    <td>${formatCurrency(forfaitFinal.portfolioValue)}</td>
                    <td>${formatCurrency(forfaitFinal.cumulativeTax)}</td>
                    <td>${formatCurrency(forfaitFinal.portfolioValue - totalContributed)}</td>
                    <td>${((forfaitFinal.cumulativeTax / forfaitFinal.portfolioValue) * 100).toFixed(2)}%</td>
                </tr>
                <tr>
                    <td><strong>Box 3 Revamped</strong></td>
                    <td>${formatCurrency(accrualFinal.portfolioValue)}</td>
                    <td>${formatCurrency(accrualFinal.cumulativeTax)}</td>
                    <td>${formatCurrency(accrualFinal.portfolioValue - totalContributed)}</td>
                    <td>${((accrualFinal.cumulativeTax / accrualFinal.portfolioValue) * 100).toFixed(2)}%</td>
                </tr>
                <tr>
                    <td><strong>Timmerfrans Special</strong></td>
                    <td>${formatCurrency(laborFinal.portfolioValue)}</td>
                    <td>${formatCurrency(laborFinal.cumulativeTax)}</td>
                    <td>${formatCurrency(laborFinal.portfolioValue - totalContributed)}</td>
                    <td>${((laborFinal.cumulativeTax / laborFinal.portfolioValue) * 100).toFixed(2)}%</td>
                </tr>
            `;
            
            // Update charts
            updateCharts();
        }
        
        function updateCharts() {
            const { forfait, accrual, labor, dates } = calculationResults;
            
            // Portfolio Value Chart
            const ctxPortfolio = document.getElementById('portfolioChart').getContext('2d');
            if (portfolioChart) portfolioChart.destroy();
            
            portfolioChart = new Chart(ctxPortfolio, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Box 3 Old School',
                            data: forfait.map(r => r.portfolioValue),
                            borderColor: '#FF6B6B',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        },
                        {
                            label: 'Box 3 Revamped',
                            data: accrual.map(r => r.portfolioValue),
                            borderColor: '#4ECDC4',
                            backgroundColor: 'rgba(78, 205, 196, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        },
                        {
                            label: 'Timmerfrans Special',
                            data: labor.map(r => r.portfolioValue),
                            borderColor: '#95E1D3',
                            backgroundColor: 'rgba(149, 225, 211, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '‚Ç¨' + Math.round(value / 1000) + 'k';
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: 12
                            }
                        }
                    }
                }
            });
            
            // Tax Chart
            const ctxTax = document.getElementById('taxChart').getContext('2d');
            if (taxChart) taxChart.destroy();
            
            taxChart = new Chart(ctxTax, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Box 3 Old School',
                            data: forfait.map(r => r.cumulativeTax),
                            borderColor: '#FF6B6B',
                            backgroundColor: 'rgba(255, 107, 107, 0.3)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Box 3 Revamped',
                            data: accrual.map(r => r.cumulativeTax),
                            borderColor: '#4ECDC4',
                            backgroundColor: 'rgba(78, 205, 196, 0.3)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Timmerfrans Special',
                            data: labor.map(r => r.cumulativeTax),
                            borderColor: '#95E1D3',
                            backgroundColor: 'rgba(149, 225, 211, 0.3)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‚Ç¨' + Math.round(value / 1000) + 'k';
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: 12
                            }
                        }
                    }
                }
            });
        }
        
        function downloadCSV() {
            if (!calculationResults) return;
            
            const { forfait, accrual, labor, dates } = calculationResults;
            
            let csv = 'Date,Box 3 Old School Portfolio,Box 3 Old School Tax,Box 3 Revamped Portfolio,Box 3 Revamped Tax,Timmerfrans Special Portfolio,Timmerfrans Special Tax\n';
            
            dates.forEach((date, idx) => {
                csv += `${date},${forfait[idx].portfolioValue.toFixed(2)},${forfait[idx].cumulativeTax.toFixed(2)},`;
                csv += `${accrual[idx].portfolioValue.toFixed(2)},${accrual[idx].cumulativeTax.toFixed(2)},`;
                csv += `${labor[idx].portfolioValue.toFixed(2)},${labor[idx].cumulativeTax.toFixed(2)}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tax_model_comparison.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        // Calculate on page load
        window.addEventListener('load', () => {
            calculate();
        });
    </script>
</body>
</html>
